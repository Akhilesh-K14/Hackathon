<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crop Planning & Seasonal Guide ‚Äî Farm Manager</title>
  <style>
    :root{--accent:#2f8f6a;--muted:#666;--success:#27ae60;--warning:#f39c12;--danger:#e74c3c}
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, Arial; margin:0;background:#f4f7f6; color:#0b1320}
    header{background:linear-gradient(90deg,#ffffffcc, #eaf6f0); padding:18px 22px; display:flex;align-items:center;justify-content:space-between;gap:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:46px;height:46px;border-radius:10px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
    .container{max-width:1400px;margin:20px auto;padding:20px}
    .card{background:white;border-radius:12px;padding:20px;box-shadow:0 6px 18px rgba(11,19,32,0.06);margin-bottom:20px}
    .btn{background:var(--accent);color:white;padding:8px 16px;border-radius:8px;border:0;cursor:pointer;text-decoration:none;display:inline-block}
    .btn-secondary{background:#6c757d;color:white;padding:8px 16px;border-radius:8px;border:0;cursor:pointer;text-decoration:none;display:inline-block}
    .btn-success{background:var(--success);color:white;padding:8px 16px;border-radius:8px;border:0;cursor:pointer}
    .btn-warning{background:var(--warning);color:white;padding:8px 16px;border-radius:8px;border:0;cursor:pointer}
    .btn-danger{background:var(--danger);color:white;padding:8px 16px;border-radius:8px;border:0;cursor:pointer}
    input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e2e8f0;margin-top:6px}
    label{font-size:13px;color:#223;font-weight:600}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px}
    .grid-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:20px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:12px;border-bottom:1px solid #eef3f2;text-align:left}
    th{background:#f8f9fa;font-weight:600}
    .weather-card{background:linear-gradient(135deg, #74b9ff, #0984e3);color:white;padding:20px;border-radius:12px;text-align:center}
    .crop-card{border:2px solid #ddd;border-radius:8px;padding:15px;margin:10px 0;transition:all 0.3s ease}
    .crop-card:hover{border-color:var(--accent);box-shadow:0 4px 12px rgba(47,143,106,0.2)}
    .crop-card.recommended{border-color:var(--success);background:#f8fff8}
    .season-badge{padding:4px 8px;border-radius:20px;font-size:12px;font-weight:600}
    .season-spring{background:#27ae60;color:white}
    .season-summer{background:#f39c12;color:white}
    .season-autumn{background:#e67e22;color:white}
    .season-winter{background:#3498db;color:white}
    .activity-log{max-height:300px;overflow-y:auto}
    .activity-item{padding:10px;border-left:4px solid var(--accent);margin:10px 0;background:#f8f9fa}
    .market-trend-up{color:var(--success);font-weight:600}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .market-trend-down{color:var(--danger);font-weight:600}
    .market-trend-stable{color:var(--warning);font-weight:600}
    .forecast-day{text-align:center;padding:15px;border:1px solid #eee;border-radius:8px;margin:5px}
    .ml-prediction{background:linear-gradient(135deg, #a29bfe, #6c5ce7);color:white;padding:20px;border-radius:12px}
    .tip-card{background:#fff3cd;border-left:5px solid var(--warning);padding:15px;margin:10px 0}
    .calendar-grid{display:grid;grid-template-columns:repeat(7, 1fr);gap:2px;margin-top:10px}
    .calendar-day{padding:10px;text-align:center;border:1px solid #eee;min-height:60px;position:relative}
    .calendar-day.has-activity{background:#e8f5e8;border-color:var(--success)}
    .calendar-day.planting-season{background:#fff3cd;border-color:var(--warning)}
    .calendar-day.harvest-season{background:#d4edda;border-color:var(--success)}
    @media (max-width:1024px){.grid-4,.grid-3,.grid-2{grid-template-columns:1fr} .container{padding:12px}}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">üåæ</div>
      <div>
        <div style="font-weight:700">Crop Planning & Seasonal Guide</div>
        <div style="color:var(--muted)">Smart farming decisions with data insights</div>
      </div>
    </div>
    <div style="display:flex;gap:12px;align-items:center">
      <a href="/dashboard" class="btn-secondary">Back to Dashboard</a>
      <button id="refreshData" class="btn">Refresh Data</button>
    </div>
  </header>

  <div class="container">
    <!-- Location & Settings -->
    <div class="card">
      <h2 style="margin-top:0">üìç Location & Farm Settings</h2>
      <div class="grid-2">
        <div>
          <label>Current Location (City Name)</label>
          <div style="display: flex; gap: 10px; margin-top: 6px;">
            <input type="text" id="locationInput" placeholder="Enter city name (e.g., Mumbai, Delhi, Bangalore)" style="flex: 1;">
            <button class="btn" id="updateLocation">Update Location</button>
          </div>
          <div id="currentLocationDisplay" style="margin-top: 8px; padding: 8px; background: #e8f5e8; border-radius: 5px; font-size: 14px;">
            <strong>Current:</strong> <span id="displayLocation">Bhimavaram (Default)</span>
          </div>
        </div>
        <div>
          <label>Soil Type</label>
          <select id="soilType">
            <option value="alluvial">Alluvial Soil</option>
            <option value="black">Black Soil (Regur)</option>
            <option value="red">Red Soil</option>
            <option value="laterite">Laterite Soil</option>
            <option value="sandy">Sandy Soil</option>
            <option value="clay">Clay Soil</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Weather Forecast -->
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2 style="margin:0">üå§Ô∏è Weather Forecast</h2>
        <button class="btn btn-primary" id="refreshWeather" style="padding: 8px 16px; font-size: 14px;">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
      </div>
      <div id="weatherLoader" style="display: none; text-align: center; padding: 20px;">
        <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <p style="margin-top: 10px;">Fetching weather data...</p>
      </div>
      <div id="weatherForecast" class="grid-4">
        <!-- Weather cards will be populated here -->
        <div class="forecast-day weather-card">
          <div style="font-weight:600">Today</div>
          <div style="font-size:24px;margin:10px 0">üå§Ô∏è</div>
          <div>28¬∞C</div>
          <div style="font-size:12px;margin-top:5px">Partly Cloudy</div>
          <div style="font-size:12px;color:#b3d9ff">Rain: 20%</div>
        </div>
        <div class="forecast-day weather-card">
          <div style="font-weight:600">Tomorrow</div>
          <div style="font-size:24px;margin:10px 0">üå¶Ô∏è</div>
          <div>26¬∞C</div>
          <div style="font-size:12px;margin-top:5px">Light Rain</div>
          <div style="font-size:12px;color:#b3d9ff">Rain: 70%</div>
        </div>
        <div class="forecast-day weather-card">
          <div style="font-weight:600">Day 3</div>
          <div style="font-size:24px;margin:10px 0">‚òÄÔ∏è</div>
          <div>30¬∞C</div>
          <div style="font-size:12px;margin-top:5px">Sunny</div>
          <div style="font-size:12px;color:#b3d9ff">Rain: 5%</div>
        </div>
        <div class="forecast-day weather-card">
          <div style="font-weight:600">Day 4</div>
          <div style="font-size:24px;margin:10px 0">‚òÄÔ∏è</div>
          <div>32¬∞C</div>
          <div style="font-size:12px;margin-top:5px">Sunny</div>
          <div style="font-size:12px;color:#b3d9ff">Rain: 0%</div>
        </div>
      </div>
      <div id="weatherError" style="display: none; padding: 15px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; color: #856404;">
        <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
        <span>Unable to load weather data. Please try again later.</span>
      </div>
    </div>

    <!-- ML Predictions & Crop Suggestions -->
    <div class="grid-2">
      <div class="card">
        <h3 style="margin-top:0">ü§ñ AI Crop Recommendations</h3>
        <div class="ml-prediction">
          <h4 style="margin-top:0">Based on Current Weather Data & ML Model</h4>
          <div id="mlLoader" style="display: none; text-align: center; padding: 10px;">
            <div style="display: inline-block; width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid #ffffff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <span style="margin-left: 10px;">Analyzing weather data...</span>
          </div>
          <div id="mlPredictions">
            <p>Loading AI-powered crop recommendations based on your location's weather conditions...</p>
            <ul id="predictionsList" style="margin:0">
              <li><strong>Loading...</strong> Please wait while we analyze weather data</li>
            </ul>
          </div>
          <div id="weatherInfo" style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 5px; font-size: 13px;">
            <strong>Weather Data:</strong> <span id="weatherDetails">Loading...</span>
          </div>
        </div>
        
        <div style="margin-top:20px">
          <h4>Suggested Crops for Your Location & Soil</h4>
          <div id="cropSuggestions">
            <!-- Dynamic crop cards will be inserted here -->
            <div class="crop-card">
              <h5 style="margin:0 0 10px 0">ÔøΩ Loading Recommendations...</h5>
              <p style="margin:5px 0">Please wait while we analyze your location's weather data</p>
              <div>
                <span class="season-badge season-winter">Analyzing...</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">üìà Local Market Insights</h3>
        <table>
          <thead>
            <tr><th>Crop</th><th>Current Price</th><th>Trend</th><th>Demand</th></tr>
          </thead>
          <tbody>
            <tr>
              <td>Wheat</td>
              <td>‚Çπ2,200/quintal</td>
              <td class="market-trend-up">‚Üó +5%</td>
              <td class="market-trend-up">High</td>
            </tr>
            <tr>
              <td>Rice</td>
              <td>‚Çπ1,800/quintal</td>
              <td class="market-trend-stable">‚Üí Stable</td>
              <td class="market-trend-stable">Medium</td>
            </tr>
            <tr>
              <td>Cotton</td>
              <td>‚Çπ5,500/quintal</td>
              <td class="market-trend-up">‚Üó +3%</td>
              <td class="market-trend-up">High</td>
            </tr>
            <tr>
              <td>Sugarcane</td>
              <td>‚Çπ350/quintal</td>
              <td class="market-trend-down">‚Üò -2%</td>
              <td class="market-trend-down">Low</td>
            </tr>
            <tr>
              <td>Maize</td>
              <td>‚Çπ1,950/quintal</td>
              <td class="market-trend-stable">‚Üí Stable</td>
              <td class="market-trend-stable">Medium</td>
            </tr>
          </tbody>
        </table>
        
        <div style="margin-top:15px;padding:15px;background:#d4edda;border-radius:8px">
          <strong>üí∞ Market Tip:</strong> Wheat prices are rising due to export demand. Consider increasing wheat cultivation area for better returns.
        </div>
      </div>
    </div>

    <!-- Crop Calendar -->
    <div class="card">
      <h3 style="margin-top:0">üìÖ Crop Calendar - September 2025</h3>
      <div style="display:flex;justify-content:between;align-items:center;margin-bottom:15px">
        <div>
          <button class="btn-secondary" id="prevMonth">‚Üê Previous</button>
          <span style="margin:0 15px;font-weight:600">September 2025</span>
          <button class="btn-secondary" id="nextMonth">Next ‚Üí</button>
        </div>
        <div>
          <span style="background:#fff3cd;padding:5px 10px;border-radius:5px;margin-right:10px">üå± Planting Season</span>
          <span style="background:#d4edda;padding:5px 10px;border-radius:5px">üåæ Harvest Season</span>
        </div>
      </div>
      
      <div class="calendar-grid">
        <div style="font-weight:600;text-align:center;padding:10px">Sun</div>
        <div style="font-weight:600;text-align:center;padding:10px">Mon</div>
        <div style="font-weight:600;text-align:center;padding:10px">Tue</div>
        <div style="font-weight:600;text-align:center;padding:10px">Wed</div>
        <div style="font-weight:600;text-align:center;padding:10px">Thu</div>
        <div style="font-weight:600;text-align:center;padding:10px">Fri</div>
        <div style="font-weight:600;text-align:center;padding:10px">Sat</div>
        
        <div class="calendar-day">1</div>
        <div class="calendar-day">2</div>
        <div class="calendar-day">3</div>
        <div class="calendar-day">4</div>
        <div class="calendar-day planting-season">5<div style="font-size:10px;color:var(--warning)">Plant Rabi</div></div>
        <div class="calendar-day">6</div>
        <div class="calendar-day">7</div>
        <div class="calendar-day">8</div>
        <div class="calendar-day">9</div>
        <div class="calendar-day has-activity">10<div style="font-size:10px;color:var(--success)">Today</div></div>
        <div class="calendar-day">11</div>
        <div class="calendar-day planting-season">12<div style="font-size:10px;color:var(--warning)">Wheat Prep</div></div>
        <div class="calendar-day">13</div>
        <div class="calendar-day">14</div>
        <div class="calendar-day harvest-season">15<div style="font-size:10px;color:var(--success)">Rice Harvest</div></div>
        <div class="calendar-day">16</div>
        <div class="calendar-day">17</div>
        <div class="calendar-day">18</div>
        <div class="calendar-day">19</div>
        <div class="calendar-day planting-season">20<div style="font-size:10px;color:var(--warning)">Mustard Plant</div></div>
        <div class="calendar-day">21</div>
        <div class="calendar-day">22</div>
        <div class="calendar-day">23</div>
        <div class="calendar-day">24</div>
        <div class="calendar-day harvest-season">25<div style="font-size:10px;color:var(--success)">Cotton Pick</div></div>
        <div class="calendar-day">26</div>
        <div class="calendar-day">27</div>
        <div class="calendar-day">28</div>
        <div class="calendar-day">29</div>
        <div class="calendar-day">30</div>
      </div>
    </div>

    <!-- Seasonal Tips & Farming Journal -->
    <div class="grid-2">
      <div class="card">
        <h3 style="margin-top:0">üí° Seasonal Tips</h3>
        <div class="tip-card">
          <h4 style="margin:0 0 10px 0">üçÇ September - Autumn Preparations</h4>
          <ul style="margin:0">
            <li>Start preparing fields for Rabi season crops</li>
            <li>Complete harvesting of Kharif crops (rice, cotton)</li>
            <li>Apply organic manure to improve soil fertility</li>
            <li>Check irrigation systems before winter planting</li>
          </ul>
        </div>
        
        <div style="margin-top:15px">
          <h4>Upcoming Seasonal Activities</h4>
          <div style="padding:10px;background:#f8f9fa;border-radius:8px;margin:10px 0">
            <strong>October:</strong> Begin wheat and mustard sowing, pest control for standing crops
          </div>
          <div style="padding:10px;background:#f8f9fa;border-radius:8px;margin:10px 0">
            <strong>November:</strong> Monitor crop growth, apply fertilizers, prepare for cold weather
          </div>
          <div style="padding:10px;background:#f8f9fa;border-radius:8px;margin:10px 0">
            <strong>December:</strong> Protect crops from frost, plan for Rabi harvest schedule
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">üìñ Farming Journal</h3>
        <div style="margin-bottom:15px">
          <label>Add New Activity</label>
          <div style="display:flex;gap:10px;margin-top:10px">
            <select id="activityType" style="width:auto">
              <option value="planting">Planting</option>
              <option value="watering">Watering</option>
              <option value="fertilizing">Fertilizing</option>
              <option value="pest-control">Pest Control</option>
              <option value="harvesting">Harvesting</option>
              <option value="soil-prep">Soil Preparation</option>
            </select>
            <input type="text" id="activityNote" placeholder="Activity details..." style="flex:1">
            <button class="btn-success" id="addActivity">Add</button>
          </div>
        </div>
        
        <div class="activity-log" id="activityLog">
          <div class="activity-item">
            <div style="font-weight:600">üå± Planting - Sept 8, 2025</div>
            <div>Planted wheat seeds in north field (2 acres)</div>
          </div>
          <div class="activity-item">
            <div style="font-weight:600">üíß Watering - Sept 7, 2025</div>
            <div>Irrigated rice crop after 3 dry days</div>
          </div>
          <div class="activity-item">
            <div style="font-weight:600">üåæ Harvesting - Sept 5, 2025</div>
            <div>Completed cotton harvesting in south field</div>
          </div>
          <div class="activity-item">
            <div style="font-weight:600">üß™ Fertilizing - Sept 3, 2025</div>
            <div>Applied NPK fertilizer to maize crop</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Alerts & Reminders -->
    <div class="card">
      <h4 style="margin-top:0">üö® Alerts & Reminders</h4>
      <div style="padding:10px;background:#fff3cd;border-radius:8px;margin:10px 0;border-left:4px solid var(--warning)">
        <strong>‚ö†Ô∏è Pest Alert:</strong> Army worm reported in nearby farms. Monitor maize crops closely.
      </div>
      <div style="padding:10px;background:#d4edda;border-radius:8px;margin:10px 0;border-left:4px solid var(--success)">
        <strong>‚úÖ Reminder:</strong> Apply second dose of fertilizer to wheat crop (Due: Sept 15)
      </div>
      <div style="padding:10px;background:#cce5ff;border-radius:8px;margin:10px 0;border-left:4px solid #007bff">
        <strong>‚ÑπÔ∏è Info:</strong> Government subsidy available for organic farming (Apply by Sept 30)
      </div>
    </div>
  </div>

  <script>
    // Initialize page functionality
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Crop Planning page loaded');
      
      // Global variables for current location
      let currentLocation = {
        name: 'Bhimavaram',
        lat: 16.5449,
        lon: 81.5212
      };
      
      // Add activity to journal
      document.getElementById('addActivity').addEventListener('click', function() {
        const activityType = document.getElementById('activityType').value;
        const activityNote = document.getElementById('activityNote').value.trim();
        
        if (!activityNote) {
          alert('Please enter activity details');
          return;
        }
        
        const today = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD format
        
        // Save to database
        fetch('/api/journal', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            activity: activityType,
            activity_details: activityNote,
            date: today
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Clear input
            document.getElementById('activityNote').value = '';
            
            // Reload journal entries
            loadJournalEntries();
            
            alert('Activity added to farming journal!');
          } else {
            alert('Failed to save activity: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error saving activity:', error);
          alert('Failed to save activity. Please try again.');
        });
      });
      
      // Function to load journal entries from database
      function loadJournalEntries() {
        fetch('/api/journal')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const activityLog = document.getElementById('activityLog');
              
              const activityIcons = {
                'planting': 'üå±',
                'watering': 'üíß',
                'fertilizing': 'üß™',
                'pest-control': 'üêõ',
                'harvesting': 'üåæ',
                'soil-prep': 'üî®'
              };
              
              // Clear existing entries
              activityLog.innerHTML = '';
              
              // Add entries from database
              data.entries.forEach(entry => {
                const activityDisplayName = entry.activity.charAt(0).toUpperCase() + 
                  entry.activity.slice(1).replace('-', ' ');
                
                const entryElement = document.createElement('div');
                entryElement.className = 'activity-item';
                entryElement.innerHTML = `
                  <div style="font-weight:600">
                    ${activityIcons[entry.activity] || 'üìù'} ${activityDisplayName} - ${entry.date}
                    <button onclick="deleteJournalEntry(${entry.id})" style="float: right; background: #e74c3c; color: white; border: none; border-radius: 3px; padding: 2px 6px; font-size: 12px; cursor: pointer;">Delete</button>
                  </div>
                  <div>${entry.activity_details}</div>
                `;
                activityLog.appendChild(entryElement);
              });
              
              // If no entries, show placeholder
              if (data.entries.length === 0) {
                activityLog.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No journal entries yet. Add your first farming activity above!</div>';
              }
            } else {
              console.error('Failed to load journal entries:', data.error);
            }
          })
          .catch(error => {
            console.error('Error loading journal entries:', error);
          });
      }
      
      // Function to delete journal entry
      window.deleteJournalEntry = function(entryId) {
        if (confirm('Are you sure you want to delete this journal entry?')) {
          fetch('/api/delete_journal', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              entry_id: entryId
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              loadJournalEntries(); // Reload the list
              alert('Journal entry deleted successfully!');
            } else {
              alert('Failed to delete entry: ' + (data.error || 'Unknown error'));
            }
          })
          .catch(error => {
            console.error('Error deleting entry:', error);
            alert('Failed to delete entry. Please try again.');
          });
        }
      };
      
      // Load journal entries on page load
      loadJournalEntries();
      
      // Update location functionality
      document.getElementById('updateLocation').addEventListener('click', function() {
        const cityName = document.getElementById('locationInput').value.trim();
        
        if (!cityName) {
          alert('Please enter a city name');
          return;
        }
        
        updateLocationAndWeather(cityName);
      });
      
      // Enter key support for location input
      document.getElementById('locationInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          document.getElementById('updateLocation').click();
        }
      });
      
      // Function to update location and fetch weather
      function updateLocationAndWeather(cityName) {
        const updateBtn = document.getElementById('updateLocation');
        const originalText = updateBtn.textContent;
        
        // Show loading state
        updateBtn.textContent = 'Updating...';
        updateBtn.disabled = true;
        
        // First, get coordinates for the city
        fetch(`/api/geocode?city=${encodeURIComponent(cityName)}`)
          .then(response => response.json())
          .then(data => {
            if (data.success && data.location) {
              // Update current location
              currentLocation = {
                name: data.location.name,
                lat: data.location.lat,
                lon: data.location.lon,
                state: data.location.state,
                country: data.location.country
              };
              
              // Update display
              const locationDisplay = data.location.state ? 
                `${data.location.name}, ${data.location.state}` : 
                `${data.location.name}, ${data.location.country}`;
              
              document.getElementById('displayLocation').textContent = locationDisplay;
              document.getElementById('locationInput').value = '';
              
              // Load weather data and ML recommendations for new location
              loadWeatherDataForLocation();
              
              alert(`Location updated to ${locationDisplay}!`);
            } else {
              alert(`Location "${cityName}" not found. Please try a different city name.`);
            }
          })
          .catch(error => {
            console.error('Error updating location:', error);
            alert('Failed to update location. Please try again.');
          })
          .finally(() => {
            // Reset button state
            updateBtn.textContent = originalText;
            updateBtn.disabled = false;
          });
      }
      
      // Refresh data functionality
      document.getElementById('refreshData').addEventListener('click', function() {
        loadWeatherDataForLocation();
        alert('Data refreshed! Weather forecast, ML predictions, and market prices updated.');
      });
      
      // Weather refresh functionality
      document.getElementById('refreshWeather').addEventListener('click', function() {
        loadWeatherDataForLocation();
      });
      
      // Function to get weather emoji based on description
      function getWeatherEmoji(description) {
        const desc = description.toLowerCase();
        if (desc.includes('clear') || desc.includes('sunny')) return '‚òÄÔ∏è';
        if (desc.includes('cloud')) return '‚òÅÔ∏è';
        if (desc.includes('rain') || desc.includes('drizzle')) return 'üåßÔ∏è';
        if (desc.includes('storm') || desc.includes('thunder')) return '‚õàÔ∏è';
        if (desc.includes('snow')) return '‚ùÑÔ∏è';
        if (desc.includes('mist') || desc.includes('fog')) return 'üå´Ô∏è';
        if (desc.includes('partly') || desc.includes('scattered')) return '‚õÖ';
        return 'üå§Ô∏è'; // Default
      }
      
      // Function to load ML crop recommendations
      function loadCropRecommendations() {
        const mlLoader = document.getElementById('mlLoader');
        const predictionsList = document.getElementById('predictionsList');
        const weatherDetails = document.getElementById('weatherDetails');
        const cropSuggestions = document.getElementById('cropSuggestions');
        
        // Show loader
        if (mlLoader) mlLoader.style.display = 'block';
        
        const url = `/api/crop_recommendations?lat=${currentLocation.lat}&lon=${currentLocation.lon}`;
        
        fetch(url)
          .then(response => response.json())
          .then(data => {
            if (mlLoader) mlLoader.style.display = 'none';
            
            if (data.success && data.recommendations) {
              // Update ML predictions list
              const predictionsHTML = data.recommendations.map(crop => 
                `<li><strong>${crop[0]}:</strong> ${Math.round(crop[1] * 100)}% success rate ${crop[1] > 0.8 ? '(highly recommended)' : crop[1] > 0.7 ? '(recommended)' : ''}</li>`
              ).join('');
              
              if (predictionsList) {
                predictionsList.innerHTML = predictionsHTML;
              }
              
              // Update weather info
              if (weatherDetails && data.weather_data) {
                weatherDetails.textContent = `Temp: ${data.weather_data.temperature}¬∞C, Humidity: ${data.weather_data.humidity}%, Rainfall: ${Math.round(data.weather_data.rainfall)}mm`;
              }
              
              // Update crop suggestion cards
              if (cropSuggestions) {
                const cropEmojis = {
                  'Rice': 'üå±',
                  'Wheat': 'üåæ', 
                  'Cotton': 'üåø',
                  'Sugarcane': 'üéã',
                  'Maize': 'üåΩ',
                  'Pulses': 'ü´ò',
                  'Mustard': 'üåª',
                  'Barley': 'üåæ'
                };
                
                const cropSeasons = {
                  'Rice': 'Kharif Season',
                  'Wheat': 'Rabi Season',
                  'Cotton': 'Kharif Season',
                  'Sugarcane': 'Annual Crop',
                  'Maize': 'Kharif Season',
                  'Pulses': 'Rabi Season',
                  'Mustard': 'Rabi Season',
                  'Barley': 'Rabi Season'
                };
                
                const cropSeasonClass = {
                  'Kharif Season': 'season-summer',
                  'Rabi Season': 'season-winter',
                  'Annual Crop': 'season-spring'
                };
                
                const cardsHTML = data.recommendations.map((crop, index) => {
                  const [cropName, probability] = crop;
                  const emoji = cropEmojis[cropName] || 'üå±';
                  const season = cropSeasons[cropName] || 'Season-based';
                  const seasonClass = cropSeasonClass[season] || 'season-spring';
                  const isRecommended = probability > 0.8;
                  const isGood = probability > 0.7;
                  
                  return `
                    <div class="crop-card ${isRecommended ? 'recommended' : ''}">
                      <h5 style="margin:0 0 10px 0">${emoji} ${cropName} ${isRecommended ? '(Highly Recommended)' : isGood ? '(Recommended)' : ''}</h5>
                      <p style="margin:5px 0">Success Rate: ${Math.round(probability * 100)}% - Based on current weather conditions</p>
                      <div>
                        <span class="season-badge ${seasonClass}">${season}</span>
                        <span style="margin-left:10px;color:${isRecommended ? 'var(--success)' : isGood ? 'var(--warning)' : 'var(--muted)'}">${isRecommended ? '‚úì Highly suitable' : isGood ? '~ Suitable' : '‚óã Consider alternatives'}</span>
                      </div>
                    </div>
                  `;
                }).join('');
                
                cropSuggestions.innerHTML = cardsHTML;
              }
              
              console.log('ML crop recommendations loaded successfully');
            } else {
              console.error('Failed to load ML recommendations:', data.error);
              if (predictionsList) {
                predictionsList.innerHTML = '<li><strong>Error:</strong> Unable to load recommendations. Please try again later.</li>';
              }
            }
          })
          .catch(error => {
            console.error('Error fetching ML recommendations:', error);
            if (mlLoader) mlLoader.style.display = 'none';
            if (predictionsList) {
              predictionsList.innerHTML = '<li><strong>Error:</strong> Failed to connect to prediction service.</li>';
            }
          });
      }
      
      // Function to load weather data for current location
      function loadWeatherDataForLocation() {
        const weatherLoader = document.getElementById('weatherLoader');
        const weatherForecast = document.getElementById('weatherForecast');
        const weatherError = document.getElementById('weatherError');
        
        // Show loader, hide forecast and error
        weatherLoader.style.display = 'block';
        weatherForecast.style.display = 'none';
        weatherError.style.display = 'none';
        
        const url = `/api/weather_forecast?lat=${currentLocation.lat}&lon=${currentLocation.lon}&location=${encodeURIComponent(currentLocation.name)}`;
        
        fetch(url)
          .then(response => response.json())
          .then(data => {
            weatherLoader.style.display = 'none';
            
            if (data.success && data.forecast) {
              // Update weather forecast with real data
              const forecastHTML = data.forecast.map((day, index) => {
                const dayLabel = index === 0 ? 'Today' : 
                               index === 1 ? 'Tomorrow' : 
                               `Day ${index + 1}`;
                
                return `
                  <div class="forecast-day weather-card">
                    <div style="font-weight:600">${dayLabel}</div>
                    <div style="font-size:24px;margin:10px 0">${getWeatherEmoji(day.weather)}</div>
                    <div>${day.avg_temp}¬∞C</div>
                    <div style="font-size:12px;margin-top:5px">${day.weather}</div>
                    <div style="font-size:12px;color:#b3d9ff">Rain: ${day.rain_percent}%</div>
                  </div>
                `;
              }).join('');
              
              weatherForecast.innerHTML = forecastHTML;
              weatherForecast.style.display = 'grid';
              
              // Load ML recommendations after weather data is loaded
              loadCropRecommendations();
              
              console.log(`Weather loaded for ${data.location || currentLocation.name}`);
            } else {
              // Show error message
              weatherError.style.display = 'block';
              weatherForecast.style.display = 'grid'; // Show default forecast
              console.error('Weather data error:', data.error);
            }
          })
          .catch(error => {
            console.error('Error fetching weather data:', error);
            weatherLoader.style.display = 'none';
            weatherError.style.display = 'block';
            weatherForecast.style.display = 'grid'; // Show default forecast
          });
      }
      
      // Legacy function for compatibility
      function loadWeatherData() {
        loadWeatherDataForLocation();
      }
      
      // Load weather data on page load
      loadWeatherDataForLocation();
      
      // Calendar navigation (placeholder)
      document.getElementById('prevMonth').addEventListener('click', function() {
        alert('Previous month functionality - will show August 2025 calendar');
      });
      
      document.getElementById('nextMonth').addEventListener('click', function() {
        alert('Next month functionality - will show October 2025 calendar');
      });
      
      // Soil type change handler
      document.getElementById('soilType').addEventListener('change', function() {
        const soilType = this.value;
        alert(`Soil type updated to ${soilType}. Crop suggestions will be recalculated.`);
      });
    });
  </script>
</body>
</html>
